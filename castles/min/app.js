"use strict";function getParameterByName(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)","i"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}var phonecatApp=angular.module("castleApp",["ngRoute","phonecatAnimations","infinite-scroll","phonecatControllers","phonecatFilters","phonecatServices","ngDialog"]);phonecatApp.config(["$routeProvider","ngDialogProvider","$sceDelegateProvider",function(a,b,c){c.resourceUrlWhitelist(["self","http://en.wikipedia.org/wiki/**","https://en.wikipedia.org/wiki/**","http://el.wikipedia.org/wiki/**","https://el.wikipedia.org/wiki/**","http://es.wikipedia.org/wiki/**","https://es.wikipedia.org/wiki/**","http://fr.wikipedia.org/wiki/**","https://fr.wikipedia.org/wiki/**","http://de.wikipedia.org/wiki/**","https://de.wikipedia.org/wiki/**","http://ja.wikipedia.org/wiki/**","https://ja.wikipedia.org/wiki/**","http://ru.wikipedia.org/wiki/**","https://ru.wikipedia.org/wiki/**"]),b.setDefaults({className:"ngdialog-theme-default"}),a.when("/wikidata",{templateUrl:"partials/phone-list.html",controller:"CastleListCtrl"}).when("/wikidata/:wikiId",{templateUrl:"partials/phone-detail.html",controller:"PhoneDetailCtrl"}).otherwise({redirectTo:"/wikidata"})}]),function(a,b,c){function d(a){return a.complete&&("undefined"==typeof a.naturalWidth||0!==a.naturalWidth)}function e(a){return Array.prototype.slice.call(a)}var f={gridWidth:300,gutterSize:10,gridNo:"auto",direction:"ltor",refreshOnImgLoad:!0,cssGrid:!1,performantScroll:!1,pageSize:"auto",scrollContainer:"body",infiniteScrollDelay:3e3,infiniteScrollDistance:100},g=a.element,h=function(a){return a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()},i={visibility:"hidden",opacity:0,top:0,left:0,width:""},j=function(){var a=g(b);return function(b){return a[0]=b,a}}();g(document.head).append("<style>.ag-no-transition{-webkit-transition: none !important;transition: none !important;} .angular-grid{position : relative;} .angular-grid > *{opacity : 0} .angular-grid > .angular-grid-item{opacity : 1}</style>"),a.module("angularGrid",[]).directive("angularGrid",["$timeout","$window","$q","angularGridInstance",function(k,l,m,n){return{restrict:"A",scope:{model:"=angularGrid",dep_gridWidth:"=gridWidth",dep_gutterSize:"=gutterSize",dep_refreshOnImgLoad:"=refreshOnImgLoad",dep_direction:"=direction",dep_cssGrid:"=cssGrid",dep_options:"=angularGridOptions",dep_agId:"@angularGridId",gridWidth:"=agGridWidth",gutterSize:"=agGutterSize",refreshOnImgLoad:"=agRefreshOnImgLoad",direction:"=agDirection",cssGrid:"=agCssGrid",options:"=agOptions",agId:"@",pageSize:"=agPageSize",performantScroll:"=agPerformantScroll",scrollContainer:"=agScrollContainer",infiniteScroll:"&agInfiniteScroll",infiniteScrollDistance:"=agInfiniteScrollDistance",infiniteScrollDelay:"=agInfiniteScrollDelay"},link:function(o,p,q){function r(){N={},Object.keys(f).forEach(function(a){o[a]!==c?N[a]=o[a]:o["dep_"+a]!==c&&(N[a]=o["dep_"+a])}),N=a.extend({},f,N,o.options||o.dep_options),N.cssGrid&&(N.gutterSize=0),"auto"==N.pageSize&&(N.pageSize=b.offsetWidth>=768?2:3)}function s(a,b){b=b||document.body;var c=0,d=0;if(a.offsetParent)do c+=a.offsetLeft,d+=a.offsetTop,a=a.offsetParent;while(a&&a!=b);return{left:c,top:d}}function t(){var a=g(document.querySelector(N.scrollContainer)),b=a[0];return{height:b.offsetHeight,scrollHeight:b.scrollHeight,startFrom:s(K,b).top,$elm:"body"==N.scrollContainer?L:a}}function u(a,b,c){O.pageInfo=[{from:0}];var d,e,f,g=N.pageSize,h=O.scrollContInfo.height,i=h*g,j=Math.ceil(b/i),k=0;for(k=0;j>k;k++)for(var l=0,m=a.length;m>l;l++)if(d=a[l],e=k?i*k:0,f=i*(k+1),d.bottom<e||d.top>f){if(d.top>f)break}else O.pageInfo[k]||(O.pageInfo[k]={from:l}),O.pageInfo[k].to=l;O.pageInfo=O.pageInfo.map(function(a,b){var c=Math.max(b-1,0),d=Math.min(b+1,O.pageInfo.length-1);return{from:O.pageInfo[c].from,to:O.pageInfo[d].to}})}function v(a){var b,c,d,e;for(d=0,e=I.length;e>d;d++)c=j(I[d]),b=c.data(),b.$scope&&(c.data("_agOldWatchers",b.$scope.$$watchers),b.$scope.$$watchers=[]);for(d=0,e=a.length;e>d;d++)b=j(a[d]).data(),b.$scope&&(b.$scope.$$watchers=b._agOldWatchers||[],b.$scope.$digest())}function w(a){O.lastScrollPosition=a;var b;if(!O.isBusy){var c=0,d=N.pageSize;if(a>O.scrollContInfo.startFrom+O.scrollContInfo.height*d&&(c=Math.floor((a-O.scrollContInfo.startFrom)/(O.scrollContInfo.height*d))),c!=O.lastPage){O.lastPage=c;var e=O.pageInfo[c];e&&(p.children().detach(),b=Array.prototype.slice.call(I,e.from,e.to),v(b),p.append(b))}}}function x(){clearTimeout(O.infiniteScrollTimeout),O.isLoading=!1}function y(a){if(!O.isLoading&&o.model.length){var b=O.scrollContInfo.scrollHeight,c=O.scrollContInfo.height;a>=b-c*(1+N.infiniteScrollDistance/100)&&(O.isLoading=!0,o.infiniteScroll(),O.infiniteScrollTimeout=setTimeout(x,N.infiniteScrollDelay))}}function z(){var a=this.scrollTop||this.scrollY;N.performantScroll&&w(a),o.infiniteScroll&&y(a)}function A(){var a,b=K.offsetWidth;if(N.cssGrid){a=g(I[0]).clone(),a.css(i).addClass("ag-no-transition"),p.append(a);var c=a[0].offsetWidth;return a.remove(),{no:Math.floor((b+12)/c),width:c}}var d="auto"==N.gridNo?N.gridWidth:Math.floor(b/N.gridNo)-N.gutterSize,e="auto"==N.gridNo?Math.floor(b/(d+N.gutterSize)):N.gridNo,f=b%(d+N.gutterSize)+N.gutterSize;return d+=Math.floor(f/e),{no:e,width:d}}function B(b,c){var f=c.beforeLoad||a.noop,g=c.onLoad||a.noop,h=c.isLoaded||a.noop,i=c.onFullLoad||a.noop,j=c.ignoreCheck||a.noop,k=b.find("img"),l=[];e(k).forEach(function(a){f(a),d(a)||j(a)?h(a):l.push(m(function(b,c){a.onload=function(){g(a),b()},a.onerror=c}))}),l.length?m.all(l).then(i,i):setTimeout(function(){i()},0)}function C(){var b,c=A(),d=c.width,f=c.no,h=[];for(b=0;f>b;b++)h.push(0);e(I).forEach(function(a){var b=j(a);e(b.find("img")).forEach(function(a){var c=g(a);if(c.hasClass("img-loaded"))return void c.css("height","");b.addClass("ag-no-transition"),b.css("width",d+"px");var e=c.attr("actual-width")||c.attr("data-actual-width"),f=c.attr("actual-height")||c.attr("data-actual-height");e&&f&&c.css("height",f*a.width/e+"px")}),b.removeClass("ag-no-transition")});var k=I.clone();k.addClass("ag-no-transition");var l=a.extend({},i);l.width=d+"px",k.css(l),p.append(k),B(k,{ignoreCheck:function(a){return!j(a).hasClass("img-loaded")},onFullLoad:function(){var a,b,c,e=[],g=[];for(b=0,c=k.length;c>b;b++)e.push(k[b].offsetHeight);for(b=0,c=I.length;c>b;b++){a=j(I[b]);var i=e[b],l=Math.min.apply(Math,h),m=h.indexOf(l);h[m]=l+i+N.gutterSize;var n=m*(d+N.gutterSize),q={position:"absolute",top:l+"px"};"rtol"==N.direction?q.right=n+"px":q.left=n+"px",q.width=d+"px",g.push({top:l,bottom:l+i}),a.css(q).addClass("angular-grid-item")}var r=Math.max.apply(Math,h);p.css("height",r+"px"),k.remove(),(N.performantScroll||o.infiniteScroll)&&(O.scrollContInfo=t()),N.performantScroll&&(O.lastPage=null,u(g,r,f),O.isBusy=!1,w(O.lastScrollPosition||0)),x()}})}function D(){var a=!1;e(I).forEach(function(b){var c=g(b),d=c.find("img");d.length&&(c.addClass("img-loading"),B(c,{beforeLoad:function(a){j(a).addClass("img-loading")},isLoaded:function(a){j(a).removeClass("img-loading").addClass("img-loaded")},onLoad:function(b){!a&&N.refreshOnImgLoad&&(a=!0,k(function(){C(),a=!1},100)),j(b).removeClass("img-loading").addClass("img-loaded")},onFullLoad:function(){c.removeClass("img-loading").addClass("img-loaded")}}))})}function E(){var a=e(I).filter(function(a){return j(a).hasClass("ng-leave")});return m(function(b){a.length?j(a[0]).one("webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd",function(){k(function(){I=p.children(),b()})}):b()})}function F(){O.isBusy=!0,k(function(){I=p.children(),E().then(function(){D(),k(function(){C()})})})}function G(){r(),I&&C()}function H(){O.isBusy=!0;var a=K.offsetWidth;P!=a&&(P=a,J&&k.cancel(J),J=k(function(){N.performantScroll&&(p.children().detach(),p.append(I)),C()},100))}var I,J,K=p[0],L=g(l),M=o.agId||o.dep_agId;p.addClass("angular-grid");var N;["gridWidth","gutterSize","refreshOnImgLoad","direction","options","cssGrid","agId"].forEach(function(a){var b=h(a),d="ag-"+h(a);"options"==a&&(b="angular-grid-options"),"agId"==a&&(b="angular-grid-id",d="ag-id"),o["dep_"+a]!==c&&console&&console.warn&&console.warn(b+" is deprecated. Use "+d+" instead in template.")}),r();var O={};setTimeout(function(){O.scrollContInfo=t(),O.scrollContInfo.$elm.on("scroll",z)},0),o.$watch("model",F,!0),o.$watch("options",G,!0),Object.keys(f).forEach(function(a){o[a]!==c&&o.$watch(a,G)});var P=K.offsetWidth;L.on("resize",H),M&&(n[M]={refresh:function(){F()},handleScroll:function(a){N.performantScroll&&w(a),o.infiniteScroll&&y(a)}}),o.$on("$destroy",function(){M&&delete n[M],L.off("resize",H),clearTimeout(O.infiniteScrollTimeout),O.scrollContInfo&&O.scrollContInfo.$elm.off("scroll",z)})}}}]).factory("angularGridInstance",function(){var a={};return a})}(angular,window);var phonecatAnimations=angular.module("phonecatAnimations",["ngAnimate"]);phonecatAnimations.animation(".phone",function(){var a=function(a,b,c){return"active"==b?(a.css({position:"absolute",top:0,left:500,display:"block"}),jQuery(a).animate({left:0},c),function(b){b&&a.stop()}):void 0},b=function(a,b,c){return"active"==b?(a.css({position:"absolute",left:0,top:0}),jQuery(a).animate({left:-500},c),function(b){b&&a.stop()}):void 0};return{addClass:a,removeClass:b}});var phonecatControllers=angular.module("phonecatControllers",[]);phonecatControllers.directive("cesiumDirective",["$interval",function(a){return{restrict:"EA",controllerAs:"cesiumCtrl",scope:{data:"="},controller:["$scope",function(a){}],link:function(a,b,c,d){d.cesium=new Cesium.Viewer(b[0],{fullscreenButton:!1,navigationInstructionsInitiallyVisible:!0,homeButton:!1,sceneModePicker:!0,timeline:!1,animation:!1});var e={centerLong:7.69043*Math.PI/180,centerLat:48.864715*Math.PI/180};d.cesium.camera.flyTo({destination:new Cesium.Cartesian3.fromDegrees(180*e.centerLong/Math.PI,180*e.centerLat/Math.PI,5e6)});var f=a.$parent;f.child=a,f.addMarkers()}}}]),phonecatControllers.controller("CastleListCtrl",["$scope","Phone","ngDialog",function(a,b,c){a.child={},a.locale={en:{loadingMessage:"... loading all castles with an English Wikipedia article ...",showingEng1:"Showing",showingEng2:"out of",showingEng3:"castles",View:"View",MapTooltip:"Click on a castle icon to open the related Wikipedia article"},de:{loadingMessage:"... alle Burgen mit deutschen Wikipedia Artikeln werden geladen ...",showingEng1:"Angezeigt werden",showingEng2:"von",showingEng3:"Burgen",View:"Ansicht",MapTooltip:"Klicken Sie auf ein Burg-Symbol um den Wikipedia Artikel zu öffnen"},fr:{loadingMessage:"... tous les châteaux avec un article Wikipedia anglais sont chargés ...",showingEng1:"Affichage",showingEng2:"sur",showingEng3:"châteaux",View:"Vue",MapTooltip:"Cliquez sur l'icône du château pour ouvrir l'article de Wikipedia liés"},el:{loadingMessage:"... όλα τα κάστρα με το άρθρο αγγλική Wikipedia είναι φορτωμένο ...",showingEng1:"εμφανίζοντας",showingEng2:"από",showingEng3:"κάστρα",View:"Θέα",MapTooltip:"Κάντε κλικ σε ένα εικονίδιο για την αναζήτηση Wikipedia"},es:{loadingMessage:"... todos los castillos con un artículo de Wikipedia Inglés se están cargando ...",showingEng1:"Mostrando",showingEng2:"de",showingEng3:"castillos",View:"Vista",MapTooltip:"clic en un icono para consultar artículo de Wikipedia"},ja:{loadingMessage:"... 英語版ウィキペディアの記事とのすべての城がロードされています ...",showingEng1:"を表示",showingEng2:"城のうち",showingEng3:"",View:"ビュー",MapTooltip:"ウィキペディアを照会するには、アイコンをクリックし"},ru:{loadingMessage:"... все замки со статьей английской Википедии загружаются ...",showingEng1:"Показаны",showingEng2:"из",showingEng3:"замков",View:"вид",MapTooltip:"Нажмите на иконку , чтобы увидеть статью в Википедии"}};var d=null===getParameterByName("lng")?"en":getParameterByName("lng");a.current={wikiId:null===d?"en":d,loadingMessage:a.locale[d].loadingMessage,showingEng1:a.locale[d].showingEng1,showingEng2:a.locale[d].showingEng2,showingEng3:a.locale[d].showingEng3,View:a.locale[d].View,MapTooltip:a.locale[d].MapTooltip},console.debug("#"+d+"Btn"),$("#"+d+"Btn").addClass("activeLanguage"),a.changeLanguage=function(b){var c=window.location.href,d="";b!==a.current.wikiId&&($("#loading").removeClass("fadingOut").addClass("fadingIn"),setTimeout(function(){a.setCesiumActive(!1),c.indexOf("?")>-1&&(c=c.substring(0,c.indexOf("?"))),d=c+"?lng="+b,$("#loading").find("p").html(a.locale[b].loadingMessage),window.location.replace(d),$("#loading").find("p").css("display","block")},1e3))},a.setCesiumActive=function(b){b?(a.cesiumActive=!0,$(".cesiumContainer").css("display","block"),$(".cesiumContainer").css("top","60px"),$(".fa-map").css("opacity","1"),$(".fa-th").css("opacity","0.3"),$("body").css("overflow-y","hidden"),$(".navbar").css("padding-right","15px"),$(".log").css("opacity","0"),$(".mapTooltip").css("display","block"),$(".search-filter").css("opacity","0")):(a.cesiumActive=!1,$(".cesiumContainer").css("display","none"),$(".fa-map").css("opacity","0.3"),$(".fa-th").css("opacity","1"),$("body").css("overflow-y","scroll"),$(".navbar").css("padding-right","0px"),$(".log").css("opacity","1"),$(".mapTooltip").css("display","none"),$(".search-filter").css("opacity","1"))},a.flyTo=function(b){a.setCesiumActive(!0);var c=JSON.parse($(b.currentTarget).attr("data-coo")),d=c[1];console.debug("flyTo",c,typeof c,d,parseFloat(c[1]),parseFloat(c[0])),a.child.cesiumCtrl.cesium.camera.flyTo({destination:new Cesium.Cartesian3.fromDegrees(parseFloat(c[1]),parseFloat(c[0]),2500)})},a.addMarkers=function(){console.debug("inside addMarkers with"+a.phones.length+"castles");for(var b=0;b<a.phones.length;b++)void 0!==a.child.cesiumCtrl&&a.child.cesiumCtrl.cesium.entities.add({position:new Cesium.Cartesian3.fromDegrees(parseFloat(a.phones[b][1][1]),parseFloat(a.phones[b][1][0]),50),id:a.phones[b][0],name:a.phones[b][0],billboard:{image:"rook.png",width:32,height:32},description:'<iframe style="padding: 10px; width: calc(100% - 15px); opacity: 0.9; height: calc(100% - 60px); background: white;" class="wikiframe" src="http://'+a.current.wikiId+".wikipedia.org/wiki/"+a.phones[b][0]+'?printable=yes"  frameborder="0">                      <p>Your browser does not support iframes.</p>              </iframe>'})},a.open=function(b){a.currImage=$($(b.currentTarget).find("img")).attr("data-fullurl"),""!==a.currImage&&c.open({template:"firstDialogId",scope:a})},a.openWiki=function(b){a.currURL=$(b.currentTarget).attr("data-wikiURL"),console.debug(a.currURL),c.open({template:"wikiDialogId",scope:a})},a.initialLoad=!1,a.cesiumActive=!1,a.currImage="",a.currURL="",console.debug(" language id ",a.current.wikiId),a.phones=b(a.current.wikiId).query(),a.castleAmount=0,a.lookAdv=function(b){console.debug("inside lookAdv(query) with",b),b=b.toUpperCase();for(var c=0,d=0;d<a.phones.length;d++)if(-1!==a.phones[d][0].toUpperCase().indexOf(b))if(-1==a.images.indexOf(a.phones[d])){if(console.debug("found and added",a.phones[d][0]),a.images.push(a.phones[d]),c++,10===c)break}else console.debug("!added",a.phones[d][0])},a.phones.$promise.then(function(b){a.castleAmount=b.length,console.debug("castles full",b);for(var c=0;c<b.length;c++)null===b[c][2]||null===b[c][3]||-1!==b[c][3].indexOf("…")?b[c][2]="rook3.png":-1!==b[c][2].indexOf("…")&&(b[c][2]=b[c][3]);a.phones=b,a.images=[];for(var c=1;40>=c;c++)a.images.push(a.phones[c]);a.initialLoad||(a.initialLoad=!0,a.addMarkers()),setTimeout(function(){$(".cesiumContainer").css("display","none"),$("#loading").addClass("fadingOut"),$("#loading").find("p").css("display","none")},1e3)}),a.loadMore=function(){for(var b=a.images.length+1,c=b;b+8>c;c++)-1==a.images.indexOf(a.phones[c])&&a.images.push(a.phones[c])},a.orderProp="age"}]),phonecatControllers.controller("PhoneDetailCtrl",["$scope","$routeParams","Phone",function(a,b,c){a.phone=c.get({wikiId:b.wikiId},function(b){a.mainImageUrl=b.images[0]}),a.setImage=function(b){a.mainImageUrl=b}}]),angular.module("phonecatFilters",[]).filter("checkmark",function(){return function(a){return a?"✓":"✘"}});var phonecatServices=angular.module("phonecatServices",["ngResource"]);phonecatServices.factory("Phone",["$resource",function(a){return function(b){return a("wikidata/:wikiId.json",{},{query:{method:"GET",params:{wikiId:"castles_"+b},isArray:!0}})}}]);